import{Fragment as ee,computed as x,defineComponent as N,h as Q,inject as te,nextTick as H,onMounted as J,onUnmounted as oe,provide as ae,ref as A,toRaw as C,watch as W,watchEffect as G}from"vue";import{Features as q,render as K,omit as X,compact as ne}from'../../utils/render.js';import{useId as U}from'../../hooks/use-id.js';import{Keys as E}from'../../keyboard.js';import{calculateActiveIndex as le,Focus as V}from'../../utils/calculate-active-index.js';import{dom as g}from'../../utils/dom.js';import{useOpenClosed as ie,State as _,useOpenClosedProvider as ue}from'../../internal/open-closed.js';import{match as j}from'../../utils/match.js';import{useResolveButtonType as re}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as se}from'../../hooks/use-tree-walker.js';import{sortByDomNode as de}from'../../utils/focus-management.js';import{useOutsideClick as fe}from'../../hooks/use-outside-click.js';import{Hidden as pe,Features as be}from'../../internal/hidden.js';import{objectToFormEntries as ve}from'../../utils/form.js';import{useControllable as me}from'../../hooks/use-controllable.js';import{useTrackedPointer as ce}from'../../hooks/use-tracked-pointer.js';import{isMobile as xe}from'../../utils/platform.js';import{disposables as Y}from'../../utils/disposables.js';import{getOwnerDocument as ge}from'../../utils/owner.js';import{history as Z}from'../../utils/active-element-history.js';function Se(a,T){return a===T}var Ce=(p=>(p[p.Open=0]="Open",p[p.Closed=1]="Closed",p))(Ce||{}),Oe=(p=>(p[p.Single=0]="Single",p[p.Multi=1]="Multi",p))(Oe||{}),Re=(O=>(O[O.Pointer=0]="Pointer",O[O.Focus=1]="Focus",O[O.Other=2]="Other",O))(Re||{});let z=Symbol("ComboboxContext");function $(a){let T=te(z,null);if(T===null){let p=new Error(`<${a} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(p,$),p}return T}let Ge=N({name:"Combobox",emits:{"update:modelValue":a=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>Se},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},form:{type:String,optional:!0},name:{type:String,optional:!0},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1},immediate:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(a,{slots:T,attrs:p,emit:O}){let t=A(1),e=A(null),y=A(null),f=A(null),r=A(null),b=A({static:!1,hold:!1}),v=A([]),R=A(null),h=A(2),M=A(!1);function L(n=u=>u){let u=R.value!==null?v.value[R.value]:null,s=de(n(v.value.slice()),d=>g(d.dataRef.domRef)),i=u?s.indexOf(u):null;return i===-1&&(i=null),{options:s,activeOptionIndex:i}}let k=x(()=>a.multiple?1:0),S=x(()=>a.nullable),[F,o]=me(x(()=>a.modelValue),n=>O("update:modelValue",n),x(()=>a.defaultValue)),m=x(()=>F.value===void 0?j(k.value,{[1]:[],[0]:void 0}):F.value),c=null,I=null,l={comboboxState:t,value:m,mode:k,compare(n,u){if(typeof a.by=="string"){let s=a.by;return(n==null?void 0:n[s])===(u==null?void 0:u[s])}return a.by(n,u)},defaultValue:x(()=>a.defaultValue),nullable:S,immediate:x(()=>a.immediate),inputRef:y,labelRef:e,buttonRef:f,optionsRef:r,disabled:x(()=>a.disabled),options:v,change(n){o(n)},activeOptionIndex:x(()=>{if(M.value&&R.value===null&&v.value.length>0){let n=v.value.findIndex(u=>!u.dataRef.disabled);n!==-1&&(R.value=n)}return R.value}),activationTrigger:h,optionsPropsRef:b,closeCombobox(){M.value=!1,!a.disabled&&t.value!==1&&(t.value=1,R.value=null)},openCombobox(){if(M.value=!0,a.disabled||t.value===0)return;let n=v.value.findIndex(u=>{let s=C(u.dataRef.value);return j(k.value,{[0]:()=>l.compare(C(l.value.value),C(s)),[1]:()=>C(l.value.value).some(d=>l.compare(C(d),C(s)))})});n!==-1&&(R.value=n),t.value=0},setActivationTrigger(n){h.value=n},goToOption(n,u,s){M.value=!1,c!==null&&cancelAnimationFrame(c),c=requestAnimationFrame(()=>{if(a.disabled||r.value&&!b.value.static&&t.value===1)return;let i=L();if(i.activeOptionIndex===null){let P=i.options.findIndex(B=>!B.dataRef.disabled);P!==-1&&(i.activeOptionIndex=P)}let d=le(n===V.Specific?{focus:V.Specific,id:u}:{focus:n},{resolveItems:()=>i.options,resolveActiveIndex:()=>i.activeOptionIndex,resolveId:P=>P.id,resolveDisabled:P=>P.dataRef.disabled});R.value=d,h.value=s!=null?s:2,v.value=i.options})},selectOption(n){let u=v.value.find(i=>i.id===n);if(!u)return;let{dataRef:s}=u;o(j(k.value,{[0]:()=>s.value,[1]:()=>{let i=C(l.value.value).slice(),d=C(s.value),P=i.findIndex(B=>l.compare(d,C(B)));return P===-1?i.push(d):i.splice(P,1),i}}))},selectActiveOption(){if(l.activeOptionIndex.value===null)return;let{dataRef:n,id:u}=v.value[l.activeOptionIndex.value];o(j(k.value,{[0]:()=>n.value,[1]:()=>{let s=C(l.value.value).slice(),i=C(n.value),d=s.findIndex(P=>l.compare(i,C(P)));return d===-1?s.push(i):s.splice(d,1),s}})),l.goToOption(V.Specific,u)},registerOption(n,u){I&&cancelAnimationFrame(I);let s={id:n,dataRef:u},i=L(d=>(d.push(s),d));if(R.value===null){let d=u.value.value;j(k.value,{[0]:()=>l.compare(C(l.value.value),C(d)),[1]:()=>C(l.value.value).some(B=>l.compare(C(B),C(d)))})&&(i.activeOptionIndex=i.options.indexOf(s))}v.value=i.options,R.value=i.activeOptionIndex,h.value=2,i.options.some(d=>!g(d.dataRef.domRef))&&(I=requestAnimationFrame(()=>{let d=L();v.value=d.options,R.value=d.activeOptionIndex}))},unregisterOption(n){var s;l.activeOptionIndex.value!==null&&((s=l.options.value[l.activeOptionIndex.value])==null?void 0:s.id)===n&&(M.value=!0);let u=L(i=>{let d=i.findIndex(P=>P.id===n);return d!==-1&&i.splice(d,1),i});v.value=u.options,R.value=u.activeOptionIndex,h.value=2}};fe([y,f,r],()=>l.closeCombobox(),x(()=>t.value===0)),ae(z,l),ue(x(()=>j(t.value,{[0]:_.Open,[1]:_.Closed})));let w=x(()=>l.activeOptionIndex.value===null?null:v.value[l.activeOptionIndex.value].dataRef.value),D=x(()=>{var n;return(n=g(y))==null?void 0:n.closest("form")});return J(()=>{W([D],()=>{if(!D.value||a.defaultValue===void 0)return;function n(){l.change(a.defaultValue)}return D.value.addEventListener("reset",n),()=>{var u;(u=D.value)==null||u.removeEventListener("reset",n)}},{immediate:!0})}),()=>{let{name:n,disabled:u,form:s,...i}=a,d={open:t.value===0,disabled:u,activeIndex:l.activeOptionIndex.value,activeOption:w.value,value:m.value};return Q(ee,[...n!=null&&m.value!=null?ve({[n]:m.value}).map(([P,B])=>Q(pe,ne({features:be.Hidden,key:P,as:"input",type:"hidden",hidden:!0,readOnly:!0,form:s,name:P,value:B}))):[],K({theirProps:{...p,...X(i,["modelValue","defaultValue","nullable","multiple","immediate","onUpdate:modelValue","by"])},ourProps:{},slot:d,slots:T,attrs:p,name:"Combobox"})])}}}),Qe=N({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"},id:{type:String,default:()=>`headlessui-combobox-label-${U()}`}},setup(a,{attrs:T,slots:p}){let O=$("ComboboxLabel");function t(){var e;(e=g(O.inputRef))==null||e.focus({preventScroll:!0})}return()=>{let e={open:O.comboboxState.value===0,disabled:O.disabled.value},{id:y,...f}=a,r={id:y,ref:O.labelRef,onClick:t};return K({ourProps:r,theirProps:f,slot:e,attrs:T,slots:p,name:"ComboboxLabel"})}}}),Xe=N({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"},id:{type:String,default:()=>`headlessui-combobox-button-${U()}`}},setup(a,{attrs:T,slots:p,expose:O}){let t=$("ComboboxButton");O({el:t.buttonRef,$el:t.buttonRef});function e(r){t.disabled.value||(t.comboboxState.value===0?t.closeCombobox():(r.preventDefault(),t.openCombobox()),H(()=>{var b;return(b=g(t.inputRef))==null?void 0:b.focus({preventScroll:!0})}))}function y(r){switch(r.key){case E.ArrowDown:r.preventDefault(),r.stopPropagation(),t.comboboxState.value===1&&t.openCombobox(),H(()=>{var b;return(b=t.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return;case E.ArrowUp:r.preventDefault(),r.stopPropagation(),t.comboboxState.value===1&&(t.openCombobox(),H(()=>{t.value.value||t.goToOption(V.Last)})),H(()=>{var b;return(b=t.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return;case E.Escape:if(t.comboboxState.value!==0)return;r.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&r.stopPropagation(),t.closeCombobox(),H(()=>{var b;return(b=t.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return}}let f=re(x(()=>({as:a.as,type:T.type})),t.buttonRef);return()=>{var h,M;let r={open:t.comboboxState.value===0,disabled:t.disabled.value,value:t.value.value},{id:b,...v}=a,R={ref:t.buttonRef,id:b,type:f.value,tabindex:"-1","aria-haspopup":"listbox","aria-controls":(h=g(t.optionsRef))==null?void 0:h.id,"aria-expanded":t.comboboxState.value===0,"aria-labelledby":t.labelRef.value?[(M=g(t.labelRef))==null?void 0:M.id,b].join(" "):void 0,disabled:t.disabled.value===!0?!0:void 0,onKeydown:y,onClick:e};return K({ourProps:R,theirProps:v,slot:r,attrs:T,slots:p,name:"ComboboxButton"})}}}),Ye=N({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function},defaultValue:{type:String,default:void 0},id:{type:String,default:()=>`headlessui-combobox-input-${U()}`}},emits:{change:a=>!0,clearInput:null},setup(a,{emit:T,attrs:p,slots:O,expose:t}){let e=$("ComboboxInput"),y=x(()=>ge(g(e.inputRef))),f={value:!1};t({el:e.inputRef,$el:e.inputRef});function r(){e.change(null);let o=g(e.optionsRef);o&&(o.scrollTop=0),e.goToOption(V.Nothing)}let b=x(()=>{var m;let o=e.value.value;return g(e.inputRef)?typeof a.displayValue!="undefined"&&o!==void 0?(m=a.displayValue(o))!=null?m:"":typeof o=="string"?o:"":""});J(()=>{W([b,e.comboboxState,y],([o,m],[c,I])=>{if(f.value)return;let l=g(e.inputRef);l&&(I===0&&m===1?(l.value=o,o||T("clearInput")):o!==c&&(l.value=o),requestAnimationFrame(()=>{var n;if(f.value||!l||((n=y.value)==null?void 0:n.activeElement)!==l)return;let{selectionStart:w,selectionEnd:D}=l;Math.abs((D!=null?D:0)-(w!=null?w:0))===0&&w===0&&l.setSelectionRange(l.value.length,l.value.length)}))},{immediate:!0}),W([e.comboboxState],([o],[m])=>{if(o===0&&m===1){if(f.value)return;let c=g(e.inputRef);if(!c)return;let I=c.value,{selectionStart:l,selectionEnd:w,selectionDirection:D}=c;c.value="",c.value=I,D!==null?c.setSelectionRange(l,w,D):c.setSelectionRange(l,w)}})});let v=A(!1);function R(){v.value=!0}function h(){Y().nextFrame(()=>{v.value=!1})}function M(o){switch(f.value=!0,o.key){case E.Enter:if(f.value=!1,e.comboboxState.value!==0||v.value)return;if(o.preventDefault(),o.stopPropagation(),e.activeOptionIndex.value===null){e.closeCombobox();return}e.selectActiveOption(),e.mode.value===0&&e.closeCombobox();break;case E.ArrowDown:return f.value=!1,o.preventDefault(),o.stopPropagation(),j(e.comboboxState.value,{[0]:()=>e.goToOption(V.Next),[1]:()=>e.openCombobox()});case E.ArrowUp:return f.value=!1,o.preventDefault(),o.stopPropagation(),j(e.comboboxState.value,{[0]:()=>e.goToOption(V.Previous),[1]:()=>{e.openCombobox(),H(()=>{e.value.value||e.goToOption(V.Last)})}});case E.Home:if(o.shiftKey)break;return f.value=!1,o.preventDefault(),o.stopPropagation(),e.goToOption(V.First);case E.PageUp:return f.value=!1,o.preventDefault(),o.stopPropagation(),e.goToOption(V.First);case E.End:if(o.shiftKey)break;return f.value=!1,o.preventDefault(),o.stopPropagation(),e.goToOption(V.Last);case E.PageDown:return f.value=!1,o.preventDefault(),o.stopPropagation(),e.goToOption(V.Last);case E.Escape:if(f.value=!1,e.comboboxState.value!==0)return;o.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&o.stopPropagation(),e.nullable.value&&e.mode.value===0&&e.value.value===null&&r(),e.closeCombobox();break;case E.Tab:if(f.value=!1,e.comboboxState.value!==0)return;e.mode.value===0&&e.activationTrigger.value!==1&&e.selectActiveOption(),e.closeCombobox();break}}function L(o){T("change",o),e.nullable.value&&e.mode.value===0&&o.target.value===""&&r(),e.openCombobox()}function k(o){var c,I,l;let m=(c=o.relatedTarget)!=null?c:Z.find(w=>w!==o.currentTarget);if(f.value=!1,!((I=g(e.optionsRef))!=null&&I.contains(m))&&!((l=g(e.buttonRef))!=null&&l.contains(m))&&e.comboboxState.value===0)return o.preventDefault(),e.mode.value===0&&(e.nullable.value&&e.value.value===null?r():e.activationTrigger.value!==1&&e.selectActiveOption()),e.closeCombobox()}function S(o){var c,I,l;let m=(c=o.relatedTarget)!=null?c:Z.find(w=>w!==o.currentTarget);(I=g(e.buttonRef))!=null&&I.contains(m)||(l=g(e.optionsRef))!=null&&l.contains(m)||e.disabled.value||e.immediate.value&&e.comboboxState.value!==0&&(e.openCombobox(),Y().nextFrame(()=>{e.setActivationTrigger(1)}))}let F=x(()=>{var o,m,c,I;return(I=(c=(m=a.defaultValue)!=null?m:e.defaultValue.value!==void 0?(o=a.displayValue)==null?void 0:o.call(a,e.defaultValue.value):null)!=null?c:e.defaultValue.value)!=null?I:""});return()=>{var D,n,u,s,i,d;let o={open:e.comboboxState.value===0},{id:m,displayValue:c,onChange:I,...l}=a,w={"aria-controls":(D=e.optionsRef.value)==null?void 0:D.id,"aria-expanded":e.comboboxState.value===0,"aria-activedescendant":e.activeOptionIndex.value===null||(n=e.options.value[e.activeOptionIndex.value])==null?void 0:n.id,"aria-labelledby":(i=(u=g(e.labelRef))==null?void 0:u.id)!=null?i:(s=g(e.buttonRef))==null?void 0:s.id,"aria-autocomplete":"list",id:m,onCompositionstart:R,onCompositionend:h,onKeydown:M,onInput:L,onFocus:S,onBlur:k,role:"combobox",type:(d=p.type)!=null?d:"text",tabIndex:0,ref:e.inputRef,defaultValue:F.value,disabled:e.disabled.value===!0?!0:void 0};return K({ourProps:w,theirProps:l,slot:o,attrs:p,slots:O,features:q.RenderStrategy|q.Static,name:"ComboboxInput"})}}}),Ze=N({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(a,{attrs:T,slots:p,expose:O}){let t=$("ComboboxOptions"),e=`headlessui-combobox-options-${U()}`;O({el:t.optionsRef,$el:t.optionsRef}),G(()=>{t.optionsPropsRef.value.static=a.static}),G(()=>{t.optionsPropsRef.value.hold=a.hold});let y=ie(),f=x(()=>y!==null?(y.value&_.Open)===_.Open:t.comboboxState.value===0);return se({container:x(()=>g(t.optionsRef)),enabled:x(()=>t.comboboxState.value===0),accept(r){return r.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:r.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(r){r.setAttribute("role","none")}}),()=>{var R,h,M;let r={open:t.comboboxState.value===0},b={"aria-labelledby":(M=(R=g(t.labelRef))==null?void 0:R.id)!=null?M:(h=g(t.buttonRef))==null?void 0:h.id,id:e,ref:t.optionsRef,role:"listbox","aria-multiselectable":t.mode.value===1?!0:void 0},v=X(a,["hold"]);return K({ourProps:b,theirProps:v,slot:r,attrs:T,slots:p,features:q.RenderStrategy|q.Static,visible:f.value,name:"ComboboxOptions"})}}}),ze=N({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(a,{slots:T,attrs:p,expose:O}){let t=$("ComboboxOption"),e=`headlessui-combobox-option-${U()}`,y=A(null);O({el:y,$el:y});let f=x(()=>t.activeOptionIndex.value!==null?t.options.value[t.activeOptionIndex.value].id===e:!1),r=x(()=>j(t.mode.value,{[0]:()=>t.compare(C(t.value.value),C(a.value)),[1]:()=>C(t.value.value).some(S=>t.compare(C(S),C(a.value)))})),b=x(()=>({disabled:a.disabled,value:a.value,domRef:y}));J(()=>t.registerOption(e,b)),oe(()=>t.unregisterOption(e)),G(()=>{t.comboboxState.value===0&&f.value&&t.activationTrigger.value!==0&&H(()=>{var S,F;return(F=(S=g(y))==null?void 0:S.scrollIntoView)==null?void 0:F.call(S,{block:"nearest"})})});function v(S){if(a.disabled)return S.preventDefault();t.selectOption(e),xe()||requestAnimationFrame(()=>{var F;return(F=g(t.inputRef))==null?void 0:F.focus({preventScroll:!0})}),t.mode.value===0&&requestAnimationFrame(()=>t.closeCombobox())}function R(){if(a.disabled)return t.goToOption(V.Nothing);t.goToOption(V.Specific,e)}let h=ce();function M(S){h.update(S)}function L(S){h.wasMoved(S)&&(a.disabled||f.value||t.goToOption(V.Specific,e,0))}function k(S){h.wasMoved(S)&&(a.disabled||f.value&&(t.optionsPropsRef.value.hold||t.goToOption(V.Nothing)))}return()=>{let{disabled:S}=a,F={active:f.value,selected:r.value,disabled:S},o={id:e,ref:y,role:"option",tabIndex:S===!0?void 0:-1,"aria-disabled":S===!0?!0:void 0,"aria-selected":r.value,disabled:void 0,onClick:v,onFocus:R,onPointerenter:M,onMouseenter:M,onPointermove:L,onMousemove:L,onPointerleave:k,onMouseleave:k};return K({ourProps:o,theirProps:a,slot:F,attrs:p,slots:T,name:"ComboboxOption"})}}});export{Ge as Combobox,Xe as ComboboxButton,Ye as ComboboxInput,Qe as ComboboxLabel,ze as ComboboxOption,Ze as ComboboxOptions};
