import A,{createContext as Q,createRef as de,useContext as Z,useEffect as ee,useMemo as H,useReducer as ge,useRef as J,useState as ce}from"react";import{match as k}from'../../utils/match.js';import{forwardRefWithAs as X,render as Y,Features as te}from'../../utils/render.js';import{optionalRef as Se,useSyncRefs as j}from'../../hooks/use-sync-refs.js';import{useId as V}from'../../hooks/use-id.js';import{Keys as w}from'../keyboard.js';import{isDisabledReactIssue7711 as ve}from'../../utils/bugs.js';import{getFocusableElements as ne,Focus as G,focusIn as U,isFocusableElement as Ae,FocusableMode as Re,FocusResult as le}from'../../utils/focus-management.js';import{OpenClosedProvider as Oe,State as $,useOpenClosed as Te}from'../../internal/open-closed.js';import{useResolveButtonType as Ce}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as Me}from'../../hooks/use-outside-click.js';import{getOwnerDocument as xe}from'../../utils/owner.js';import{useOwnerDocument as ae}from'../../hooks/use-owner.js';import{useEventListener as Fe}from'../../hooks/use-event-listener.js';import{Hidden as pe,Features as se}from'../../internal/hidden.js';import{useEvent as g}from'../../hooks/use-event.js';import{useTabDirection as me,Direction as N}from'../../hooks/use-tab-direction.js';import'../../utils/micro-task.js';import{useLatestValue as ye}from'../../hooks/use-latest-value.js';import{useIsoMorphicEffect as Ie}from'../../hooks/use-iso-morphic-effect.js';import{useMainTreeNode as _e,useRootContainers as Le}from'../../hooks/use-root-containers.js';import{useNestedPortals as Be}from'../../components/portal/portal.js';var De=(u=>(u[u.Open=0]="Open",u[u.Closed=1]="Closed",u))(De||{}),he=(e=>(e[e.TogglePopover=0]="TogglePopover",e[e.ClosePopover=1]="ClosePopover",e[e.SetButton=2]="SetButton",e[e.SetButtonId=3]="SetButtonId",e[e.SetPanel=4]="SetPanel",e[e.SetPanelId=5]="SetPanelId",e))(he||{});let He={[0]:t=>{let o={...t,popoverState:k(t.popoverState,{[0]:1,[1]:0})};return o.popoverState===0&&(o.__demoMode=!1),o},[1](t){return t.popoverState===1?t:{...t,popoverState:1}},[2](t,o){return t.button===o.button?t:{...t,button:o.button}},[3](t,o){return t.buttonId===o.buttonId?t:{...t,buttonId:o.buttonId}},[4](t,o){return t.panel===o.panel?t:{...t,panel:o.panel}},[5](t,o){return t.panelId===o.panelId?t:{...t,panelId:o.panelId}}},ue=Q(null);ue.displayName="PopoverContext";function oe(t){let o=Z(ue);if(o===null){let u=new Error(`<${t} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(u,oe),u}return o}let ie=Q(null);ie.displayName="PopoverAPIContext";function fe(t){let o=Z(ie);if(o===null){let u=new Error(`<${t} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(u,fe),u}return o}let Pe=Q(null);Pe.displayName="PopoverGroupContext";function Ee(){return Z(Pe)}let re=Q(null);re.displayName="PopoverPanelContext";function Ge(){return Z(re)}function Ne(t,o){return k(o.type,He,t,o)}let ke="div";function we(t,o){var B;let{__demoMode:u=!1,...R}=t,O=J(null),n=j(o,Se(l=>{O.current=l})),e=J([]),v=ge(Ne,{__demoMode:u,popoverState:u?0:1,buttons:e,button:null,buttonId:null,panel:null,panelId:null,beforePanelSentinel:de(),afterPanelSentinel:de()}),[{popoverState:P,button:s,buttonId:F,panel:p,panelId:T,beforePanelSentinel:m,afterPanelSentinel:S},i]=v,a=ae((B=O.current)!=null?B:s),E=H(()=>{if(!s||!p)return!1;for(let K of document.querySelectorAll("body > *"))if(Number(K==null?void 0:K.contains(s))^Number(K==null?void 0:K.contains(p)))return!0;let l=ne(),x=l.indexOf(s),q=(x+l.length-1)%l.length,W=(x+1)%l.length,z=l[q],be=l[W];return!p.contains(z)&&!p.contains(be)},[s,p]),C=ye(F),h=ye(T),I=H(()=>({buttonId:C,panelId:h,close:()=>i({type:1})}),[C,h,i]),M=Ee(),D=M==null?void 0:M.registerPopover,f=g(()=>{var l;return(l=M==null?void 0:M.isFocusWithinPopoverGroup())!=null?l:(a==null?void 0:a.activeElement)&&((s==null?void 0:s.contains(a.activeElement))||(p==null?void 0:p.contains(a.activeElement)))});ee(()=>D==null?void 0:D(I),[D,I]);let[y,b]=Be(),d=Le({mainTreeNodeRef:M==null?void 0:M.mainTreeNodeRef,portals:y,defaultContainers:[s,p]});Fe(a==null?void 0:a.defaultView,"focus",l=>{var x,q,W,z;l.target!==window&&l.target instanceof HTMLElement&&P===0&&(f()||s&&p&&(d.contains(l.target)||(q=(x=m.current)==null?void 0:x.contains)!=null&&q.call(x,l.target)||(z=(W=S.current)==null?void 0:W.contains)!=null&&z.call(W,l.target)||i({type:1})))},!0),Me(d.resolveContainers,(l,x)=>{i({type:1}),Ae(x,Re.Loose)||(l.preventDefault(),s==null||s.focus())},P===0);let _=g(l=>{i({type:1});let x=(()=>l?l instanceof HTMLElement?l:"current"in l&&l.current instanceof HTMLElement?l.current:s:s)();x==null||x.focus()}),r=H(()=>({close:_,isPortalled:E}),[_,E]),c=H(()=>({open:P===0,close:_}),[P,_]),L={ref:n};return A.createElement(re.Provider,{value:null},A.createElement(ue.Provider,{value:v},A.createElement(ie.Provider,{value:r},A.createElement(Oe,{value:k(P,{[0]:$.Open,[1]:$.Closed})},A.createElement(b,null,Y({ourProps:L,theirProps:R,slot:c,defaultTag:ke,name:"Popover"}),A.createElement(d.MainTreeNode,null))))))}let Ue="button";function We(t,o){let u=V(),{id:R=`headlessui-popover-button-${u}`,...O}=t,[n,e]=oe("Popover.Button"),{isPortalled:v}=fe("Popover.Button"),P=J(null),s=`headlessui-focus-sentinel-${V()}`,F=Ee(),p=F==null?void 0:F.closeOthers,m=Ge()!==null;ee(()=>{if(!m)return e({type:3,buttonId:R}),()=>{e({type:3,buttonId:null})}},[m,R,e]);let[S]=ce(()=>Symbol()),i=j(P,o,m?null:r=>{if(r)n.buttons.current.push(S);else{let c=n.buttons.current.indexOf(S);c!==-1&&n.buttons.current.splice(c,1)}n.buttons.current.length>1&&console.warn("You are already using a <Popover.Button /> but only 1 <Popover.Button /> is supported."),r&&e({type:2,button:r})}),a=j(P,o),E=ae(P),C=g(r=>{var c,L,B;if(m){if(n.popoverState===1)return;switch(r.key){case w.Space:case w.Enter:r.preventDefault(),(L=(c=r.target).click)==null||L.call(c),e({type:1}),(B=n.button)==null||B.focus();break}}else switch(r.key){case w.Space:case w.Enter:r.preventDefault(),r.stopPropagation(),n.popoverState===1&&(p==null||p(n.buttonId)),e({type:0});break;case w.Escape:if(n.popoverState!==0)return p==null?void 0:p(n.buttonId);if(!P.current||E!=null&&E.activeElement&&!P.current.contains(E.activeElement))return;r.preventDefault(),r.stopPropagation(),e({type:1});break}}),h=g(r=>{m||r.key===w.Space&&r.preventDefault()}),I=g(r=>{var c,L;ve(r.currentTarget)||t.disabled||(m?(e({type:1}),(c=n.button)==null||c.focus()):(r.preventDefault(),r.stopPropagation(),n.popoverState===1&&(p==null||p(n.buttonId)),e({type:0}),(L=n.button)==null||L.focus()))}),M=g(r=>{r.preventDefault(),r.stopPropagation()}),D=n.popoverState===0,f=H(()=>({open:D}),[D]),y=Ce(t,P),b=m?{ref:a,type:y,onKeyDown:C,onClick:I}:{ref:i,id:n.buttonId,type:y,"aria-expanded":n.popoverState===0,"aria-controls":n.panel?n.panelId:void 0,onKeyDown:C,onKeyUp:h,onClick:I,onMouseDown:M},d=me(),_=g(()=>{let r=n.panel;if(!r)return;function c(){k(d.current,{[N.Forwards]:()=>U(r,G.First),[N.Backwards]:()=>U(r,G.Last)})===le.Error&&U(ne().filter(B=>B.dataset.headlessuiFocusGuard!=="true"),k(d.current,{[N.Forwards]:G.Next,[N.Backwards]:G.Previous}),{relativeTo:n.button})}c()});return A.createElement(A.Fragment,null,Y({ourProps:b,theirProps:O,slot:f,defaultTag:Ue,name:"Popover.Button"}),D&&!m&&v&&A.createElement(pe,{id:s,features:se.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:_}))}let Ke="div",je=te.RenderStrategy|te.Static;function Ve(t,o){let u=V(),{id:R=`headlessui-popover-overlay-${u}`,...O}=t,[{popoverState:n},e]=oe("Popover.Overlay"),v=j(o),P=Te(),s=(()=>P!==null?(P&$.Open)===$.Open:n===0)(),F=g(m=>{if(ve(m.currentTarget))return m.preventDefault();e({type:1})}),p=H(()=>({open:n===0}),[n]);return Y({ourProps:{ref:v,id:R,"aria-hidden":!0,onClick:F},theirProps:O,slot:p,defaultTag:Ke,features:je,visible:s,name:"Popover.Overlay"})}let $e="div",Je=te.RenderStrategy|te.Static;function Xe(t,o){let u=V(),{id:R=`headlessui-popover-panel-${u}`,focus:O=!1,...n}=t,[e,v]=oe("Popover.Panel"),{close:P,isPortalled:s}=fe("Popover.Panel"),F=`headlessui-focus-sentinel-before-${V()}`,p=`headlessui-focus-sentinel-after-${V()}`,T=J(null),m=j(T,o,f=>{v({type:4,panel:f})}),S=ae(T);Ie(()=>(v({type:5,panelId:R}),()=>{v({type:5,panelId:null})}),[R,v]);let i=Te(),a=(()=>i!==null?(i&$.Open)===$.Open:e.popoverState===0)(),E=g(f=>{var y;switch(f.key){case w.Escape:if(e.popoverState!==0||!T.current||S!=null&&S.activeElement&&!T.current.contains(S.activeElement))return;f.preventDefault(),f.stopPropagation(),v({type:1}),(y=e.button)==null||y.focus();break}});ee(()=>{var f;t.static||e.popoverState===1&&((f=t.unmount)==null||f)&&v({type:4,panel:null})},[e.popoverState,t.unmount,t.static,v]),ee(()=>{if(e.__demoMode||!O||e.popoverState!==0||!T.current)return;let f=S==null?void 0:S.activeElement;T.current.contains(f)||U(T.current,G.First)},[e.__demoMode,O,T,e.popoverState]);let C=H(()=>({open:e.popoverState===0,close:P}),[e,P]),h={ref:m,id:R,onKeyDown:E,onBlur:O&&e.popoverState===0?f=>{var b,d,_,r,c;let y=f.relatedTarget;y&&T.current&&((b=T.current)!=null&&b.contains(y)||(v({type:1}),((_=(d=e.beforePanelSentinel.current)==null?void 0:d.contains)!=null&&_.call(d,y)||(c=(r=e.afterPanelSentinel.current)==null?void 0:r.contains)!=null&&c.call(r,y))&&y.focus({preventScroll:!0})))}:void 0,tabIndex:-1},I=me(),M=g(()=>{let f=T.current;if(!f)return;function y(){k(I.current,{[N.Forwards]:()=>{var d;U(f,G.First)===le.Error&&((d=e.afterPanelSentinel.current)==null||d.focus())},[N.Backwards]:()=>{var b;(b=e.button)==null||b.focus({preventScroll:!0})}})}y()}),D=g(()=>{let f=T.current;if(!f)return;function y(){k(I.current,{[N.Forwards]:()=>{var L;if(!e.button)return;let b=ne(),d=b.indexOf(e.button),_=b.slice(0,d+1),c=[...b.slice(d+1),..._];for(let B of c.slice())if(B.dataset.headlessuiFocusGuard==="true"||(L=e.panel)!=null&&L.contains(B)){let l=c.indexOf(B);l!==-1&&c.splice(l,1)}U(c,G.First,{sorted:!1})},[N.Backwards]:()=>{var d;U(f,G.Previous)===le.Error&&((d=e.button)==null||d.focus())}})}y()});return A.createElement(re.Provider,{value:R},a&&s&&A.createElement(pe,{id:F,ref:e.beforePanelSentinel,features:se.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:M}),Y({ourProps:h,theirProps:n,slot:C,defaultTag:$e,features:Je,visible:a,name:"Popover.Panel"}),a&&s&&A.createElement(pe,{id:p,ref:e.afterPanelSentinel,features:se.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:D}))}let Ye="div";function qe(t,o){let u=J(null),R=j(u,o),[O,n]=ce([]),e=_e(),v=g(i=>{n(a=>{let E=a.indexOf(i);if(E!==-1){let C=a.slice();return C.splice(E,1),C}return a})}),P=g(i=>(n(a=>[...a,i]),()=>v(i))),s=g(()=>{var E;let i=xe(u);if(!i)return!1;let a=i.activeElement;return(E=u.current)!=null&&E.contains(a)?!0:O.some(C=>{var h,I;return((h=i.getElementById(C.buttonId.current))==null?void 0:h.contains(a))||((I=i.getElementById(C.panelId.current))==null?void 0:I.contains(a))})}),F=g(i=>{for(let a of O)a.buttonId.current!==i&&a.close()}),p=H(()=>({registerPopover:P,unregisterPopover:v,isFocusWithinPopoverGroup:s,closeOthers:F,mainTreeNodeRef:e.mainTreeNodeRef}),[P,v,s,F,e.mainTreeNodeRef]),T=H(()=>({}),[]),m=t,S={ref:R};return A.createElement(Pe.Provider,{value:p},Y({ourProps:S,theirProps:m,slot:T,defaultTag:Ye,name:"Popover.Group"}),A.createElement(e.MainTreeNode,null))}let ze=X(we),Qe=X(We),Ze=X(Ve),et=X(Xe),tt=X(qe),kt=Object.assign(ze,{Button:Qe,Overlay:Ze,Panel:et,Group:tt});export{kt as Popover};
