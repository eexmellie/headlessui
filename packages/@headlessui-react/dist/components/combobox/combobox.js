import te,{Fragment as Oe,createContext as se,createRef as ye,useCallback as Re,useContext as be,useEffect as de,useMemo as B,useReducer as ve,useRef as _}from"react";import{useComputed as re}from'../../hooks/use-computed.js';import{useDisposables as ae}from'../../hooks/use-disposables.js';import{useEvent as f}from'../../hooks/use-event.js';import{useId as q}from'../../hooks/use-id.js';import{useIsoMorphicEffect as w}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ae}from'../../hooks/use-latest-value.js';import{useOutsideClick as Ee}from'../../hooks/use-outside-click.js';import{useResolveButtonType as Pe}from'../../hooks/use-resolve-button-type.js';import{useSyncRefs as Q}from'../../hooks/use-sync-refs.js';import{useTreeWalker as Se}from'../../hooks/use-tree-walker.js';import{history as ce}from'../../utils/active-element-history.js';import{calculateActiveIndex as Ie,Focus as v}from'../../utils/calculate-active-index.js';import{disposables as fe}from'../../utils/disposables.js';import{forwardRefWithAs as X,render as j,compact as _e,Features as Te}from'../../utils/render.js';import{isDisabledReactIssue7711 as Le}from'../../utils/bugs.js';import{match as J}from'../../utils/match.js';import{objectToFormEntries as Fe}from'../../utils/form.js';import{sortByDomNode as Ve}from'../../utils/focus-management.js';import{Hidden as De,Features as Me}from'../../internal/hidden.js';import{useOpenClosed as he,State as oe,OpenClosedProvider as Be}from'../../internal/open-closed.js';import{Keys as L}from'../keyboard.js';import{useControllable as ke}from'../../hooks/use-controllable.js';import{useWatch as me}from'../../hooks/use-watch.js';import{useTrackedPointer as we}from'../../hooks/use-tracked-pointer.js';import{isMobile as Ue}from'../../utils/platform.js';import{useOwnerDocument as He}from'../../hooks/use-owner.js';var Ne=(t=>(t[t.Open=0]="Open",t[t.Closed=1]="Closed",t))(Ne||{}),Ge=(t=>(t[t.Single=0]="Single",t[t.Multi=1]="Multi",t))(Ge||{}),Xe=(n=>(n[n.Pointer=0]="Pointer",n[n.Focus=1]="Focus",n[n.Other=2]="Other",n))(Xe||{}),je=(r=>(r[r.OpenCombobox=0]="OpenCombobox",r[r.CloseCombobox=1]="CloseCombobox",r[r.GoToOption=2]="GoToOption",r[r.RegisterOption=3]="RegisterOption",r[r.UnregisterOption=4]="UnregisterOption",r[r.RegisterLabel=5]="RegisterLabel",r[r.SetActivationTrigger=6]="SetActivationTrigger",r))(je||{});function le(o,l=t=>t){let t=o.activeOptionIndex!==null?o.options[o.activeOptionIndex]:null,n=Ve(l(o.options.slice()),d=>d.dataRef.current.domRef.current),p=t?n.indexOf(t):null;return p===-1&&(p=null),{options:n,activeOptionIndex:p}}let Je={[1](o){var l;return(l=o.dataRef.current)!=null&&l.disabled||o.comboboxState===1?o:{...o,activeOptionIndex:null,comboboxState:1}},[0](o){var t;if((t=o.dataRef.current)!=null&&t.disabled||o.comboboxState===0)return o;let l=o.activeOptionIndex;if(o.dataRef.current){let{isSelected:n}=o.dataRef.current,p=o.options.findIndex(d=>n(d.dataRef.current.value));p!==-1&&(l=p)}return{...o,comboboxState:0,activeOptionIndex:l}},[2](o,l){var p,d,b,r;if((p=o.dataRef.current)!=null&&p.disabled||(d=o.dataRef.current)!=null&&d.optionsRef.current&&!((b=o.dataRef.current)!=null&&b.optionsPropsRef.current.static)&&o.comboboxState===1)return o;let t=le(o);if(t.activeOptionIndex===null){let e=t.options.findIndex(i=>!i.dataRef.current.disabled);e!==-1&&(t.activeOptionIndex=e)}let n=Ie(l,{resolveItems:()=>t.options,resolveActiveIndex:()=>t.activeOptionIndex,resolveId:e=>e.id,resolveDisabled:e=>e.dataRef.current.disabled});return{...o,...t,activeOptionIndex:n,activationTrigger:(r=l.trigger)!=null?r:2}},[3]:(o,l)=>{var d,b;let t={id:l.id,dataRef:l.dataRef},n=le(o,r=>[...r,t]);o.activeOptionIndex===null&&(d=o.dataRef.current)!=null&&d.isSelected(l.dataRef.current.value)&&(n.activeOptionIndex=n.options.indexOf(t));let p={...o,...n,activationTrigger:2};return(b=o.dataRef.current)!=null&&b.__demoMode&&o.dataRef.current.value===void 0&&(p.activeOptionIndex=0),p},[4]:(o,l)=>{let t=le(o,n=>{let p=n.findIndex(d=>d.id===l.id);return p!==-1&&n.splice(p,1),n});return{...o,...t,activationTrigger:2}},[5]:(o,l)=>({...o,labelId:l.id}),[6]:(o,l)=>({...o,activationTrigger:l.trigger})},ie=se(null);ie.displayName="ComboboxActionsContext";function Y(o){let l=be(ie);if(l===null){let t=new Error(`<${o} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(t,Y),t}return l}let ue=se(null);ue.displayName="ComboboxDataContext";function K(o){let l=be(ue);if(l===null){let t=new Error(`<${o} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(t,K),t}return l}function Ke(o,l){return J(l.type,Je,o,l)}let We=Oe;function $e(o,l){let{value:t,defaultValue:n,onChange:p,form:d,name:b,by:r=(s,m)=>s===m,disabled:e=!1,__demoMode:i=!1,nullable:P=!1,multiple:g=!1,immediate:x=!1,...O}=o,[C=g?[]:void 0,c]=ke(t,p,n),[T,S]=ve(Ke,{dataRef:ye(),comboboxState:i?0:1,options:[],activeOptionIndex:null,activationTrigger:2,labelId:null}),F=_(!1),U=_({static:!1,hold:!1}),H=_(null),N=_(null),W=_(null),Z=_(null),h=f(typeof r=="string"?(s,m)=>{let A=r;return(s==null?void 0:s[A])===(m==null?void 0:m[A])}:r),G=Re(s=>J(a.mode,{[1]:()=>C.some(m=>h(m,s)),[0]:()=>h(C,s)}),[C]),a=B(()=>({...T,immediate:x,optionsPropsRef:U,labelRef:H,inputRef:N,buttonRef:W,optionsRef:Z,value:C,defaultValue:n,disabled:e,mode:g?1:0,get activeOptionIndex(){if(F.current&&T.activeOptionIndex===null&&T.options.length>0){let s=T.options.findIndex(m=>!m.dataRef.current.disabled);if(s!==-1)return s}return T.activeOptionIndex},compare:h,isSelected:G,nullable:P,__demoMode:i}),[C,n,e,g,P,i,T]),E=_(a.activeOptionIndex!==null?a.options[a.activeOptionIndex]:null);de(()=>{let s=a.activeOptionIndex!==null?a.options[a.activeOptionIndex]:null;E.current!==s&&(E.current=s)}),w(()=>{T.dataRef.current=a},[a]),Ee([a.buttonRef,a.inputRef,a.optionsRef],()=>ne.closeCombobox(),a.comboboxState===0);let k=B(()=>({open:a.comboboxState===0,disabled:e,activeIndex:a.activeOptionIndex,activeOption:a.activeOptionIndex===null?null:a.options[a.activeOptionIndex].dataRef.current.value,value:C}),[a,e,C]),z=f(s=>{let m=a.options.find(A=>A.id===s);m&&M(m.dataRef.current.value)}),u=f(()=>{if(a.activeOptionIndex!==null){let{dataRef:s,id:m}=a.options[a.activeOptionIndex];M(s.current.value),ne.goToOption(v.Specific,m)}}),V=f(()=>{S({type:0}),F.current=!0}),R=f(()=>{S({type:1}),F.current=!1}),D=f((s,m,A)=>(F.current=!1,s===v.Specific?S({type:2,focus:v.Specific,id:m,trigger:A}):S({type:2,focus:s,trigger:A}))),y=f((s,m)=>(S({type:3,id:s,dataRef:m}),()=>{var A;((A=E.current)==null?void 0:A.id)===s&&(F.current=!0),S({type:4,id:s})})),I=f(s=>(S({type:5,id:s}),()=>S({type:5,id:null}))),M=f(s=>J(a.mode,{[0](){return c==null?void 0:c(s)},[1](){let m=a.value.slice(),A=m.findIndex($=>h($,s));return A===-1?m.push(s):m.splice(A,1),c==null?void 0:c(m)}})),xe=f(s=>{S({type:6,trigger:s})}),ne=B(()=>({onChange:M,registerOption:y,registerLabel:I,goToOption:D,closeCombobox:R,openCombobox:V,setActivationTrigger:xe,selectActiveOption:u,selectOption:z}),[]),ge=l===null?{}:{ref:l},ee=_(null),Ce=ae();return de(()=>{ee.current&&n!==void 0&&Ce.addEventListener(ee.current,"reset",()=>{c==null||c(n)})},[ee,c]),te.createElement(ie.Provider,{value:ne},te.createElement(ue.Provider,{value:a},te.createElement(Be,{value:J(a.comboboxState,{[0]:oe.Open,[1]:oe.Closed})},b!=null&&C!=null&&Fe({[b]:C}).map(([s,m],A)=>te.createElement(De,{features:Me.Hidden,ref:A===0?$=>{var pe;ee.current=(pe=$==null?void 0:$.closest("form"))!=null?pe:null}:void 0,..._e({key:s,as:"input",type:"hidden",hidden:!0,readOnly:!0,form:d,name:s,value:m})})),j({ourProps:ge,theirProps:O,slot:k,defaultTag:We,name:"Combobox"}))))}let qe="input";function Qe(o,l){var a,E,k,z;let t=q(),{id:n=`headlessui-combobox-input-${t}`,onChange:p,displayValue:d,type:b="text",...r}=o,e=K("Combobox.Input"),i=Y("Combobox.Input"),P=Q(e.inputRef,l),g=He(e.inputRef),x=_(!1),O=ae(),C=f(()=>{i.onChange(null),e.optionsRef.current&&(e.optionsRef.current.scrollTop=0),i.goToOption(v.Nothing)}),c=function(){var u;return typeof d=="function"&&e.value!==void 0?(u=d(e.value))!=null?u:"":typeof e.value=="string"?e.value:""}();me(([u,V],[R,D])=>{if(x.current)return;let y=e.inputRef.current;y&&((D===0&&V===1||u!==R)&&(y.value=u),requestAnimationFrame(()=>{if(x.current||!y||(g==null?void 0:g.activeElement)!==y)return;let{selectionStart:I,selectionEnd:M}=y;Math.abs((M!=null?M:0)-(I!=null?I:0))===0&&I===0&&y.setSelectionRange(y.value.length,y.value.length)}))},[c,e.comboboxState,g]),me(([u],[V])=>{if(u===0&&V===1){if(x.current)return;let R=e.inputRef.current;if(!R)return;let D=R.value,{selectionStart:y,selectionEnd:I,selectionDirection:M}=R;R.value="",R.value=D,M!==null?R.setSelectionRange(y,I,M):R.setSelectionRange(y,I)}},[e.comboboxState]);let T=_(!1),S=f(()=>{T.current=!0}),F=f(()=>{O.nextFrame(()=>{T.current=!1})}),U=f(u=>{switch(x.current=!0,u.key){case L.Enter:if(x.current=!1,e.comboboxState!==0||T.current)return;if(u.preventDefault(),u.stopPropagation(),e.activeOptionIndex===null){i.closeCombobox();return}i.selectActiveOption(),e.mode===0&&i.closeCombobox();break;case L.ArrowDown:return x.current=!1,u.preventDefault(),u.stopPropagation(),J(e.comboboxState,{[0]:()=>{i.goToOption(v.Next)},[1]:()=>{i.openCombobox()}});case L.ArrowUp:return x.current=!1,u.preventDefault(),u.stopPropagation(),J(e.comboboxState,{[0]:()=>{i.goToOption(v.Previous)},[1]:()=>{i.openCombobox(),O.nextFrame(()=>{e.value||i.goToOption(v.Last)})}});case L.Home:if(u.shiftKey)break;return x.current=!1,u.preventDefault(),u.stopPropagation(),i.goToOption(v.First);case L.PageUp:return x.current=!1,u.preventDefault(),u.stopPropagation(),i.goToOption(v.First);case L.End:if(u.shiftKey)break;return x.current=!1,u.preventDefault(),u.stopPropagation(),i.goToOption(v.Last);case L.PageDown:return x.current=!1,u.preventDefault(),u.stopPropagation(),i.goToOption(v.Last);case L.Escape:return x.current=!1,e.comboboxState!==0?void 0:(u.preventDefault(),e.optionsRef.current&&!e.optionsPropsRef.current.static&&u.stopPropagation(),e.nullable&&e.mode===0&&e.value===null&&C(),i.closeCombobox());case L.Tab:if(x.current=!1,e.comboboxState!==0)return;e.mode===0&&e.activationTrigger!==1&&i.selectActiveOption(),i.closeCombobox();break}}),H=f(u=>{p==null||p(u),e.nullable&&e.mode===0&&u.target.value===""&&C(),i.openCombobox()}),N=f(u=>{var R,D,y;let V=(R=u.relatedTarget)!=null?R:ce.find(I=>I!==u.currentTarget);if(x.current=!1,!((D=e.optionsRef.current)!=null&&D.contains(V))&&!((y=e.buttonRef.current)!=null&&y.contains(V))&&e.comboboxState===0)return u.preventDefault(),e.mode===0&&(e.nullable&&e.value===null?C():e.activationTrigger!==1&&i.selectActiveOption()),i.closeCombobox()}),W=f(u=>{var R,D,y;let V=(R=u.relatedTarget)!=null?R:ce.find(I=>I!==u.currentTarget);(D=e.buttonRef.current)!=null&&D.contains(V)||(y=e.optionsRef.current)!=null&&y.contains(V)||e.disabled||e.immediate&&e.comboboxState!==0&&(i.openCombobox(),O.nextFrame(()=>{i.setActivationTrigger(1)}))}),Z=re(()=>{if(e.labelId)return[e.labelId].join(" ")},[e.labelId]),h=B(()=>({open:e.comboboxState===0,disabled:e.disabled}),[e]),G={ref:P,id:n,role:"combobox",type:b,"aria-controls":(a=e.optionsRef.current)==null?void 0:a.id,"aria-expanded":e.comboboxState===0,"aria-activedescendant":e.activeOptionIndex===null||(E=e.options[e.activeOptionIndex])==null?void 0:E.id,"aria-labelledby":Z,"aria-autocomplete":"list",defaultValue:(z=(k=o.defaultValue)!=null?k:e.defaultValue!==void 0?d==null?void 0:d(e.defaultValue):null)!=null?z:e.defaultValue,disabled:e.disabled,onCompositionStart:S,onCompositionEnd:F,onKeyDown:U,onChange:H,onFocus:W,onBlur:N};return j({ourProps:G,theirProps:r,slot:h,defaultTag:qe,name:"Combobox.Input"})}let Ye="button";function Ze(o,l){var C;let t=K("Combobox.Button"),n=Y("Combobox.Button"),p=Q(t.buttonRef,l),d=q(),{id:b=`headlessui-combobox-button-${d}`,...r}=o,e=ae(),i=f(c=>{switch(c.key){case L.ArrowDown:return c.preventDefault(),c.stopPropagation(),t.comboboxState===1&&n.openCombobox(),e.nextFrame(()=>{var T;return(T=t.inputRef.current)==null?void 0:T.focus({preventScroll:!0})});case L.ArrowUp:return c.preventDefault(),c.stopPropagation(),t.comboboxState===1&&(n.openCombobox(),e.nextFrame(()=>{t.value||n.goToOption(v.Last)})),e.nextFrame(()=>{var T;return(T=t.inputRef.current)==null?void 0:T.focus({preventScroll:!0})});case L.Escape:return t.comboboxState!==0?void 0:(c.preventDefault(),t.optionsRef.current&&!t.optionsPropsRef.current.static&&c.stopPropagation(),n.closeCombobox(),e.nextFrame(()=>{var T;return(T=t.inputRef.current)==null?void 0:T.focus({preventScroll:!0})}));default:return}}),P=f(c=>{if(Le(c.currentTarget))return c.preventDefault();t.comboboxState===0?n.closeCombobox():(c.preventDefault(),n.openCombobox()),e.nextFrame(()=>{var T;return(T=t.inputRef.current)==null?void 0:T.focus({preventScroll:!0})})}),g=re(()=>{if(t.labelId)return[t.labelId,b].join(" ")},[t.labelId,b]),x=B(()=>({open:t.comboboxState===0,disabled:t.disabled,value:t.value}),[t]),O={ref:p,id:b,type:Pe(o,t.buttonRef),tabIndex:-1,"aria-haspopup":"listbox","aria-controls":(C=t.optionsRef.current)==null?void 0:C.id,"aria-expanded":t.comboboxState===0,"aria-labelledby":g,disabled:t.disabled,onClick:P,onKeyDown:i};return j({ourProps:O,theirProps:r,slot:x,defaultTag:Ye,name:"Combobox.Button"})}let ze="label";function et(o,l){let t=q(),{id:n=`headlessui-combobox-label-${t}`,...p}=o,d=K("Combobox.Label"),b=Y("Combobox.Label"),r=Q(d.labelRef,l);w(()=>b.registerLabel(n),[n]);let e=f(()=>{var g;return(g=d.inputRef.current)==null?void 0:g.focus({preventScroll:!0})}),i=B(()=>({open:d.comboboxState===0,disabled:d.disabled}),[d]);return j({ourProps:{ref:r,id:n,onClick:e},theirProps:p,slot:i,defaultTag:ze,name:"Combobox.Label"})}let tt="ul",ot=Te.RenderStrategy|Te.Static;function nt(o,l){let t=q(),{id:n=`headlessui-combobox-options-${t}`,hold:p=!1,...d}=o,b=K("Combobox.Options"),r=Q(b.optionsRef,l),e=he(),i=(()=>e!==null?(e&oe.Open)===oe.Open:b.comboboxState===0)();w(()=>{var O;b.optionsPropsRef.current.static=(O=o.static)!=null?O:!1},[b.optionsPropsRef,o.static]),w(()=>{b.optionsPropsRef.current.hold=p},[b.optionsPropsRef,p]),Se({container:b.optionsRef.current,enabled:b.comboboxState===0,accept(O){return O.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:O.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(O){O.setAttribute("role","none")}});let P=re(()=>{var O,C;return(C=b.labelId)!=null?C:(O=b.buttonRef.current)==null?void 0:O.id},[b.labelId,b.buttonRef.current]),g=B(()=>({open:b.comboboxState===0}),[b]),x={"aria-labelledby":P,role:"listbox","aria-multiselectable":b.mode===1?!0:void 0,id:n,ref:r};return j({ourProps:x,theirProps:d,slot:g,defaultTag:tt,features:ot,visible:i,name:"Combobox.Options"})}let rt="li";function at(o,l){var h,G;let t=q(),{id:n=`headlessui-combobox-option-${t}`,disabled:p=!1,value:d,...b}=o,r=K("Combobox.Option"),e=Y("Combobox.Option"),i=r.activeOptionIndex!==null?r.options[r.activeOptionIndex].id===n:!1,P=r.isSelected(d),g=_(null),x=Ae({disabled:p,value:d,domRef:g,textValue:(G=(h=g.current)==null?void 0:h.textContent)==null?void 0:G.toLowerCase()}),O=Q(l,g),C=f(()=>e.selectOption(n));w(()=>e.registerOption(n,x),[x,n]);let c=_(!r.__demoMode);w(()=>{if(!r.__demoMode)return;let a=fe();return a.requestAnimationFrame(()=>{c.current=!0}),a.dispose},[]),w(()=>{if(r.comboboxState!==0||!i||!c.current||r.activationTrigger===0)return;let a=fe();return a.requestAnimationFrame(()=>{var E,k;(k=(E=g.current)==null?void 0:E.scrollIntoView)==null||k.call(E,{block:"nearest"})}),a.dispose},[g,i,r.comboboxState,r.activationTrigger,r.activeOptionIndex]);let T=f(a=>{if(p)return a.preventDefault();C(),Ue()||requestAnimationFrame(()=>{var E;return(E=r.inputRef.current)==null?void 0:E.focus({preventScroll:!0})}),r.mode===0&&requestAnimationFrame(()=>e.closeCombobox())}),S=f(()=>{if(p)return e.goToOption(v.Nothing);e.goToOption(v.Specific,n)}),F=we(),U=f(a=>F.update(a)),H=f(a=>{F.wasMoved(a)&&(p||i||e.goToOption(v.Specific,n,0))}),N=f(a=>{F.wasMoved(a)&&(p||i&&(r.optionsPropsRef.current.hold||e.goToOption(v.Nothing)))}),W=B(()=>({active:i,selected:P,disabled:p}),[i,P,p]);return j({ourProps:{id:n,ref:O,role:"option",tabIndex:p===!0?void 0:-1,"aria-disabled":p===!0?!0:void 0,"aria-selected":P,disabled:void 0,onClick:T,onFocus:S,onPointerEnter:U,onMouseEnter:U,onPointerMove:H,onMouseMove:H,onPointerLeave:N,onMouseLeave:N},theirProps:b,slot:W,defaultTag:rt,name:"Combobox.Option"})}let lt=X($e),it=X(Ze),ut=X(Qe),pt=X(et),st=X(nt),bt=X(at),zt=Object.assign(lt,{Input:ut,Button:it,Label:pt,Options:st,Option:bt});export{zt as Combobox};
